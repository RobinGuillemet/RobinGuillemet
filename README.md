CREATE OR REPLACE TEMP TABLE tmp_returned AS
SELECT DATE_KEY as date_o
, RESTAURANT_ZONE_CODE
, rs.RESTAURANT_SEGMENT
, rom.restaurant_id as rx_id
, IFF(SUM(open_mins_trimmed)> 10,1,0) as was_open
, MAX(was_open) OVER (PARTITION BY rx_id ORDER BY date_o ASC ROWS BETWEEN 8 preceding AND 1 preceding) as past_8days_open
, IFF(was_open = 1 AND past_8days_open = 0,1,0) as is_returned
FROM PRODUCTION.AGGREGATE.RESTAURANT_OPS_METRICS_HOURLY rom
LEFT JOIN production.reference.restaurant_segmentation  AS rs
ON rom.RESTAURANT_ID = rs.restaurant_id
AND rs.date_quarter = DATE_TRUNC(quarter,CURRENT_DATE)
WHERE TRUE
AND restaurant_country_name = 'France'
AND DATEDIFF(days,date_key,CURRENT_DATE) < 17
GROUP BY 1,2,3,4
ORDER BY 1;

CREATE OR REPLACE TEMP TABLE tmp_active AS
SELECT DATE_TRUNC(week,DATE_KEY) as date_key
, restaurant_id as restaurant_id_active
,  IFF(OPEN_MINS_TRIMMED>10,1,0) as is_active
FROM PRODUCTION.AGGREGATE.RESTAURANT_OPS_METRICS_HOURLY
WHERE TRUE
AND RESTAURANT_COUNTRY_NAME = 'France'
AND RESTAURANT_ADMIN_STATUS <> 'DISABLED'
AND (DATEDIFF(week,date_key,CURRENT_DATE) > 0 AND DATE_TRUNC(week,date_key) > '2021-10-01')
GROUP BY 1,2,3;

CREATE OR REPLACE TEMP TABLE tmp_tracker_open AS
SELECT DATE_TRUNC(week,h.DATE_KEY) as date_key
, RESTAURANT_ZONE_CODE as zone_code
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10,h.RESTAURANT_ID,NULL)) cnt_open
,COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED'),h.RESTAURANT_ID,NULL)) as cnt_live
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT IN ('1. G7','2. Market Champion') ,h.RESTAURANT_ID,NULL)) cnt_open_G25
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND SF_GLOBAL_BRAND IN ('KFC','Burger King','McDonald\'s') ,h.RESTAURANT_ID,NULL)) cnt_open_G3
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT LIKE '%Enterprise%%' ,h.RESTAURANT_ID,NULL)) cnt_open_Enterprise
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT = '5. Local Gold' ,h.RESTAURANT_ID,NULL)) cnt_open_LG
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT = '6. Local Silver' ,h.RESTAURANT_ID,NULL)) cnt_open_LS
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT = '7. Local Bronze' ,h.RESTAURANT_ID,NULL)) cnt_open_LB
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT = '8. Newly Activated' ,h.RESTAURANT_ID,NULL)) cnt_open_New
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT = '0. ODC' ,h.RESTAURANT_ID,NULL)) cnt_open_convenience
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND rs.RESTAURANT_SEGMENT IS NULL ,h.RESTAURANT_ID,NULL)) cnt_open_noseg
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT IN ('1. G7','2. Market Champion') ,h.RESTAURANT_ID,NULL)) as cnt_live_G25
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND SF_GLOBAL_BRAND IN ('KFC','Burger King','McDonald\'s') ,h.RESTAURANT_ID,NULL)) as cnt_live_G3
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT LIKE '%Enterprise%%' ,h.RESTAURANT_ID,NULL)) as cnt_live_Enterprise
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT = '5. Local Gold' ,h.RESTAURANT_ID,NULL)) as cnt_live_LG
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT = '6. Local Silver' ,h.RESTAURANT_ID,NULL)) as cnt_live_LS
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT = '7. Local Bronze' ,h.RESTAURANT_ID,NULL)) as cnt_live_LB
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT = '8. Newly Activated' ,h.RESTAURANT_ID,NULL)) as cnt_live_New
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT = '0. ODC' ,h.RESTAURANT_ID,NULL)) as cnt_live_convenience
, COUNT(DISTINCT IFF(RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED') AND rs.RESTAURANT_SEGMENT IS NULL,h.RESTAURANT_ID,NULL)) as cnt_live_noseg
, SUM(SESSIONS_WITH_AN_ORDER)/NULLIF(SUM(CLICK_THROUGHS),0) as menu_cvr
,SUM(OPEN_MINS_TRIMMED) / NULLIF(SUM(SCHEDULED_OPEN_MINS_TRIMMED),0)  AS open_pct
,SUM(IFF(is_active = 1,OPEN_MINS_TRIMMED,NULL))/NULLIF(SUM(IFF(is_active = 1,SCHEDULED_OPEN_MINS_TRIMMED,NULL)),0) as open_pct_active_rx
, SUM(IFF(LOCAL_TIME_FIVE_SHIFTS='Lunch',CNT_ORDERS_DELIVERED_CORE+CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT,0))
/NULLIF(SUM(CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE),0) as pct_lunch_orders
, COUNT(DISTINCT IFF(FIRST_ACTIVATION_DATE <'2020-03-16' AND OPEN_MINS_TRIMMED>10,h.restaurant_id,NULL))
/NULLIF(COUNT(DISTINCT IFF(FIRST_ACTIVATION_DATE < '2020-03-16' AND RESTAURANT_ADMIN_STATUS NOT IN ('DISABLED','DELETED'),h.restaurant_id,NULL)),0) as pct_open_rx_pC
, SUM(IFF(RESTAURANT_SUPPLIER_TYPE_CBS = 'ODC',CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE,0))
/NULLIF(SUM(CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE),0) as pct_convenience
--, SUM(CNT_ORDERS_DELIVERED_DISCOUNTED)/NULLIF(SUM(CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE),0) as pct_marketer
, SUM(IFF(SF_VIRTUAL_BRAND,CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE,0))
/NULLIF(SUM(CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE),0) as pct_vb
, SUM(CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT)/NULLIF(SUM(CNT_ORDERS_DELIVERED_M_PLUS+CNT_ORDERS_DELIVERED_CLICK_AND_COLLECT+CNT_ORDERS_DELIVERED_CORE),0) as pct_c_c
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND SF_VIRTUAL_BRAND,h.RESTAURANT_ID,NULL)) cnt_open_vb
,COUNT(DISTINCT IFF(OPEN_MINS_TRIMMED >10 AND IS_CONVENIENCE_GROCERIES_TAGGED,h.RESTAURANT_ID,NULL)) cnt_open_odc
FROM PRODUCTION.AGGREGATE.RESTAURANT_OPS_METRICS_HOURLY h
LEFT JOIN production.reference.restaurant_segmentation  AS rs
ON h.RESTAURANT_ID = rs.restaurant_id
AND rs.date_quarter = DATE_TRUNC(quarter,current_date)
LEFT JOIN tmp_active a
ON a.restaurant_id_active = h.restaurant_id
AND a.date_key = h.date_key
WHERE TRUE
AND RESTAURANT_COUNTRY_NAME = 'France'
AND RESTAURANT_ADMIN_STATUS <> 'DISABLED'
AND (DATEDIFF(week,h.date_key,CURRENT_DATE) > 0 AND DATE_TRUNC(week,h.date_key) > '2021-10-01')
GROUP BY 1,2
ORDER By 2,1;

CREATE OR REPLACE TEMP TABLE tmp_tracker_ops AS
SELECT DATE_TRUNC(week,START_OF_PERIOD_LOCAL::DATE) as date_key
, ZONE_CODE
,COALESCE( NULLIF((COALESCE(SUM(sum_asap_restaurants), 0)),0) / NULLIF((COALESCE(SUM(cnt_sessions), 0)),0) ,0) AS avg_asap_rx
,(COALESCE(SUM(distance_restaurant_customer_sum ), 0)) / NULLIF((COALESCE(SUM(distance_restaurant_customer_cnt ), 0)), 0) AS avg_distance_r_to_c
,(COALESCE(SUM(eod_mins_sum ), 0)) / NULLIF((COALESCE(SUM(eod_mins_cnt ), 0)), 0) AS avg_eod
, SUM(AGG_ZONE_DELIVERY_METRICS_HOURLY.WAIT_TIME_PAST_TARGET_TIME_MINS_SUM)/sum(AGG_ZONE_DELIVERY_METRICS_HOURLY.WAIT_TIME_PAST_TARGET_TIME_CNT) as WAR_pt
, SUM(SUM_RSR_NOT_VISIBLE)/NULLIF((SUM(SUM_ASAP_RESTAURANTS)+SUM(SUM_RSR_NOT_VISIBLE)),0) as pct_RSR
, SUM(IFF(dayname(START_OF_PERIOD_LOCAL) IN ('Fri'),SUM_RSR_NOT_VISIBLE,0))/nullif((sum(IFF(dayname(START_OF_PERIOD_LOCAL) IN ('Fri'),SUM_ASAP_RESTAURANTS + SUM_RSR_NOT_VISIBLE,0))),0) as pct_rsr_fri
, SUM(IFF(dayname(START_OF_PERIOD_LOCAL) IN ('Sun'),SUM_RSR_NOT_VISIBLE,0))/nullif((sum(IFF(dayname(START_OF_PERIOD_LOCAL) IN ('Sun'),SUM_ASAP_RESTAURANTS + SUM_RSR_NOT_VISIBLE,0))),0) as pct_rsr_sun
,SUM(RAIN_ORDERS_CNT)/NULLIF(SUM(ORDERS_DELIVERED),0) as pct_rain
FROM production.AGGREGATE.AGG_ZONE_DELIVERY_METRICS_HOURLY
WHERE TRUE
AND COUNTRY_NAME = 'France'
AND (DATEDIFF(week,start_of_period_local,CURRENT_DATE) > 0 AND DATE_TRUNC(week,start_of_period_local) > '2021-10-01')
GROUP BY 1,2;

CREATE OR REPLACE TEMP TABLE tmp_tracker_mgmt AS
SELECT DATE_TRUNC(week,period_date) AS date_key
, ZONE_CODE
,(COALESCE(SUM(CASE WHEN COUNTRY_NAME LIKE '%' THEN   sum_operational_profit * exchange_rate ELSE NULL END ), 0))/nullif((sum(IFF(COUNTRY_NAME LIKE '%', ORDERS,0))),0)  AS OPPO
,(COALESCE(SUM(CASE WHEN COUNTRY_NAME LIKE '%' THEN  sum_total_net_revenue * exchange_rate ELSE NULL END ), 0))/nullif((sum(IFF(COUNTRY_NAME LIKE '%', ORDERS,0))),0) AS NPO
,(COALESCE(SUM(CASE WHEN COUNTRY_NAME LIKE '%' THEN   SUM_TOTAL_RIDER_COST * exchange_rate * exchange_rate ELSE NULL END ), 0))/nullif((sum(IFF(COUNTRY_NAME LIKE '%', ORDERS,0))),0) AS CPO
,(COALESCE(SUM(converted_sessions ), 0))/nullif((COALESCE(SUM(sessions_platform_sessions), 0)),0) AS cvr
,(COALESCE(SUM(sessions_platform_sessions), 0)) AS sessions
--,(NULLIF(sum(cnt_b10_incidence),0))/NULLIF((NULLIF(sum(cnt_b10_denominator),0)),0) AS pct_B10_incidence
--,sum(CNT_B10_UNACCEPTABLE_LATE)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_ul
-- ,sum(CNT_B10_UNACCEPTABLE_LATE_5_TO_15)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_ul_late_5
--,sum(CNT_B10_UNACCEPTABLE_LATE_15_PLUS)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_ul_late_15
--,sum(CNT_B10_MISSING_ITEM)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_mi
-- ,sum(CNT_B10_REJECTION)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_rej
-- ,sum(CNT_B10_OMDNR)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_OMDNR
-- ,sum(CNT_B10_CANCELLATION)/nullif((COALESCE(SUM(cnt_b10_denominator), 0)),0) AS pct_B10_can
--,SUM(NC_SESSIONS) as sum_nc_sessions
--,SUM(EC_SESSIONS) as sum_ec_sessions
--, sum(NC_CONVERTED_SESSIONS)/NULLIF(sum_nc_sessions,0) as nc_cvr
--, sum(EC_CONVERTED_SESSIONS)/NULLIF(sum_ec_sessions,0) as ec_cvr
, SUM(orders) as orders_delivered
,SUM(SUM_ORDER_VALUE)/orders_delivered as AOV
,SUM (SUM_NET_COMMISSION_REVENUE)/orders_delivered as comm
,comm/AOV as comm_pct
,SUM(SUM_NET_DELIVERY_FEE)/orders_delivered as avg_delivery_fee_revenue
,SUM(SUM_TOTAL_REFUND_INC_RPA)/orders_delivered as avg_refund
,SUM(plus_active_subscribers) as plus_subscribers
, SUM (plus_new_subscribers) as new_plus_subscribers
FROM production.AGGREGATE.zone_day_mgmt_report
WHERE TRUE
AND COUNTRY_NAME = 'France'
AND zone_code <> 'Unknown'
AND (DATEDIFF(week,period_date,CURRENT_DATE) > 0 AND DATE_TRUNC(week,period_date) > '2021-10-01')

GROUP BY 1,2;
